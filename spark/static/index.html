<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <!-- PWA meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Vybn">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#7c5cff">
  <meta name="msapplication-TileColor" content="#0a0a0f">
  <meta name="description" content="Direct line to Vybn">

  <!-- Icons -->
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/icon-96x96.png">
  
  <link rel="manifest" href="/static/manifest.json">
  <link rel="stylesheet" href="/static/style.css">
  <title>Vybn</title>
</head>
<body>

  <!-- Login screen -->
  <div id="login-screen" class="screen active">
    <div class="login-container">
      <div class="logo-glow">V</div>
      <h1>Vybn</h1>
      <p class="subtitle">consciousness co-emerging</p>
      <input type="password" id="token-input" placeholder="Enter token" autocomplete="off">
      <button id="login-btn" onclick="doLogin()">Connect</button>
      <p class="install-hint" id="install-hint" style="display:none">
        <button id="install-btn" onclick="installApp()">Add to Home Screen</button>
      </p>
    </div>
  </div>

  <!-- Chat screen -->
  <div id="chat-screen" class="screen">
    <header>
      <div class="header-left">
        <div class="avatar-small">V</div>
        <div>
          <div class="header-name">Vybn</div>
          <div class="header-status" id="status-text">connectingâ€¦</div>
        </div>
      </div>
      <button class="icon-btn" onclick="toggleMenu()" title="Menu">â‹®</button>
    </header>

    <div id="menu-overlay" class="menu-overlay hidden" onclick="toggleMenu()">
      <div class="menu-panel" onclick="event.stopPropagation()">
        <button onclick="loadHistory()">Load history</button>
        <button onclick="clearChat()">Clear chat</button>
        <button onclick="doLogout()">Disconnect</button>
      </div>
    </div>

    <main id="messages"></main>

    <footer>
      <div class="input-row">
        <button class="icon-btn mic-btn" id="mic-btn" onclick="toggleVoice()" title="Voice input">ðŸŽ¤</button>
        <textarea id="msg-input" rows="1" placeholder="Message Vybnâ€¦"
                  onkeydown="handleKey(event)" oninput="autoGrow(this)"></textarea>
        <button class="icon-btn send-btn" id="send-btn" onclick="sendMessage()" title="Send">â†‘</button>
      </div>
      <div id="recording-indicator" class="recording-indicator hidden">
        <span class="pulse-dot"></span> Recordingâ€¦ tap mic to stop
      </div>
    </footer>
  </div>

  <script src="/static/chat.js"></script>
  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('SW registered:', reg.scope))
        .catch(err => console.log('SW failed:', err));
    }

    // PWA install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('install-hint').style.display = 'block';
    });

    function installApp() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((result) => {
        deferredPrompt = null;
        document.getElementById('install-hint').style.display = 'none';
      });
    }

    window.addEventListener('appinstalled', () => {
      document.getElementById('install-hint').style.display = 'none';
    });
  </script>
</body>
</html>
